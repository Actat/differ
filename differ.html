<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>differ</title>
    </head>
    <body>
        <form name="frm">
            元のテキスト
            <textarea name="prev" rows="10"></textarea>
            変更後のテキスト
            <textarea name="curr" rows="10"></textarea>
        </form>
        <input type="submit" id="btn" value="実行">
        <div id="result"></div>
    </body>
    <script>
        // https://qiita.com/convto/items/e05d8147d9808a27b8ff
        // https://doi.org/10.1016/0020-0190(90)90035-V
        function differ() {
            var prev = document.frm.prev.value;
            var curr = document.frm.curr.value;
            var div = document.getElementById('result');
            var result = onp(prev, curr);
            div.innerHTML = formatDiff(prev, curr, result);
        }

        function formatDiff(prev, curr, result) {
            var index = [0, 0]; // [prev, curr]
            var string = "distance: " + result[0] + "<br>" + "\n";

            if (prev.length >= curr.length) {
                for (i = 0; i < result[1].length; i++) {
                    if (index[1] < result[1][i][1]) {
                        string += ' +'
                        while (index[1] < result[1][i][1]) {
                            string += curr[index[1]];
                            index[1]++;
                        }
                        string += ' ';
                    }
                    if (index[0] < result[1][i][0]) {
                        string += ' -'
                        while (index[0] < result[1][i][0]) {
                            string += prev[index[0]];
                            index[0]++;
                        }
                        string += ' ';
                    }
                    string += prev[result[1][i][0]];
                    index[0]++;
                    index[1]++;
                }
            } else {
                for (i = 0; i < result[1].length; i++) {
                    if (index[1] < result[1][i][0]) {
                        string += ' +';
                        while (index[1] < result[1][i][0]) {
                            string += curr[index[1]];
                            index[1]++;
                        }
                        string += ' ';
                    }
                    if (index[0] < result[1][i][1]) {
                        string += ' -';
                        while (index[0] < result[1][i][1]) {
                            string += prev[index[0]];
                            index[0]++;
                        }
                        string += ' ';
                    }
                    string += prev[result[1][i][1]];
                    index[0]++;
                    index[1]++;
                }
            }
            if (index[1] < curr.length) {
                string += ' +';
                while (index[1] < curr.length) {
                    string += curr[index[1]];
                    index[1]++;
                }
                string += ' ';
            }
            if (index[0] < prev.length) {
                string += ' -';
                while (index[0] < prev.length) {
                    string += prev[index[0]];
                    index[0]++;
                }
                string += ' ';
            }
            console.log(string);
            return string;
        }

        function onp(A, B) {
            // console.log("A: %s, B: %s", A, B);
            var N = A.length;
            var M = B.length;

            // N >= M が前提
            if (N < M) {
                return onp(B, A);
            }

            var delta = N - M;

            for (var p = 0;; p++) {
                // p(削除の回数)を増やしながら探索する
                var result = fp(A, B, delta, p);
                if (result[0] == N) {
                    return [delta + 2 * p, result[1]];
                }
            }
        }

        function fp(A, B, k, p) {
            var delta = A.length - B.length;
            if (!(-p <= k && k <= p + delta) || !(0 <= p && p <= B.length)) {
                // 範囲外の時ありえない数字を返しておく
                result = [-Infinity, []];
                console.log("fp(A, B, " + k + ", " + p + ") = " + result);
                return result;
            }

            if (k == 0 && p == 0) {
                var result = goDiagonally(A, B, k, p);
                return result;
            }

            var result = [];
            if (k == delta) {
                var a = fp(A, B, k - 1, p);
                var b = fp(A, B, k + 1, p);
                if (a[0] + 1 > b[0]) {
                    result = goDiagonally(A, B, k, a[0] + 1);
                    result[1] = a[1].concat(result[1]);
                } else {
                    result = goDiagonally(A, B, k, b[0]);
                    result[1] = b[1].concat(result[1]);
                }
            } else if (k > delta) {
                var a = fp(A, B, k - 1, p - 1);
                var b = fp(A, B, k + 1, p);
                if (a[0] + 1 > b[0]) {
                    result = goDiagonally(A, B, k, a[0] + 1);
                    result[1] = a[1].concat(result[1]);
                } else {
                    result = goDiagonally(A, B, k, b[0]);
                    result[1] = b[1].concat(result[1]);
                }
            } else {
                var a = fp(A, B, k - 1, p);
                var b = fp(A, B, k + 1, p - 1);
                if (a[0] + 1 > b[0]) {
                    result = goDiagonally(A, B, k, a[0] + 1);
                    result[1] = a[1].concat(result[1]);
                } else {
                    result = goDiagonally(A, B, k, b[0]);
                    result[1] = b[1].concat(result[1]);
                }
            }
            console.log("fp(A, B, " + k + ", " + p + ") = " + result);
            return result;
        }

        function goDiagonally(A, B, k, y) {
            var x = y - k;
            var common = [];

            if (x < 0 || x > B.length || y < 0 || y > A.length) {
                return [-Infinity, common];
            }
            while (0 <= y && y < A.length && 0 <= x && x < B.length && A[y] == B[x]) {
                common.push([y, x]);
                x++;
                y++;
            }
            return [y, common];
        }

        function max(list) {
            var index = 0;
            for (var i = 0; i < list.length; i++) {
                if (list[i] > list[index]) {
                    index = i;
                }
            }
            return list[index];
        }
        
        document.getElementById('btn').addEventListener("click", differ);
    </script>
</html>